# 🧪 位置情報機能のテストガイド

## ✅ エラー修正内容

以下のエラーが修正されました：

```
❌ 修正前: Geolocation error: {}
✅ 修正後: 詳細なエラー情報が表示される
```

### 修正内容

1. **エラーオブジェクトの型指定**
   - `GeolocationPositionError` 型を明示的に指定
   - エラーコードの正しい比較方法（数値で比較）

2. **詳細なログ出力**
   ```typescript
   console.error('Geolocation error details:', {
     code: error.code,
     message: error.message,
     errorName: 'PERMISSION_DENIED' // エラー名も表示
   });
   ```

3. **HTTPS接続のチェック**
   - セキュアコンテキストかどうかを事前確認
   - HTTPSでない場合は分かりやすいエラーメッセージ

4. **タイムアウトの延長**
   - 10秒 → 15秒に延長（より成功率が高い）

5. **多言語対応のエラーメッセージ**
   - すべてのエラーが翻訳キーを使用

---

## 🧪 テスト手順

### テスト1: 正常系（位置情報取得成功）

1. ブラウザでアプリを開く（HTTPS推奨）
2. 新規レポートを作成
3. 「📍 位置情報を取得」ボタンをタップ
4. ブラウザの許可ダイアログで「許可」を選択

**期待される結果：**
- コンソールに以下のログが表示される：
  ```
  Requesting geolocation...
  Geolocation success: {
    latitude: XX.XXXXX,
    longitude: XX.XXXXX,
    accuracy: XX
  }
  ```
- UI上に以下が表示される：
  ```
  ✓ 位置情報取得済み
  東京都○○区（または該当する住所）
  Lat : XX.XXXXX , Lng : XX.XXXXX
  [🔄 再取得] [🗑 削除]
  ```
- トーストメッセージ：「位置情報を取得しました」

---

### テスト2: 位置情報拒否

1. ブラウザでアプリを開く
2. 新規レポートを作成
3. 「📍 位置情報を取得」ボタンをタップ
4. ブラウザの許可ダイアログで「拒否」を選択

**期待される結果：**
- コンソールに以下のログが表示される：
  ```
  Requesting geolocation...
  Geolocation error details: {
    code: 1,
    message: "User denied Geolocation",
    errorName: "PERMISSION_DENIED"
  }
  ```
- トーストメッセージ（英語）：「Location access denied」
- トーストメッセージ（日本語）：「位置情報の取得が拒否されました」
- ボタンは元の状態に戻る

---

### テスト3: タイムアウト

**テスト方法：**
- 機内モードをオンにする
- または、地下や電波の届かない場所で試す

**期待される結果：**
- 15秒後にタイムアウト
- コンソールに以下のログが表示される：
  ```
  Requesting geolocation...
  Geolocation error details: {
    code: 3,
    message: "Timeout expired",
    errorName: "TIMEOUT"
  }
  ```
- トーストメッセージ：「位置情報の取得がタイムアウトしました」

---

### テスト4: 位置情報が利用できない

**テスト方法：**
- デバイスの位置情報サービスをオフにする
- iOS: 設定 → プライバシー → 位置情報サービス → オフ
- Android: 設定 → 位置情報 → オフ

**期待される結果：**
- コンソールに以下のログが表示される：
  ```
  Requesting geolocation...
  Geolocation error details: {
    code: 2,
    message: "Network location provider unavailable",
    errorName: "POSITION_UNAVAILABLE"
  }
  ```
- トーストメッセージ：「位置情報が利用できません」

---

### テスト5: HTTPS接続チェック

**テスト方法：**
- HTTP（非暗号化）でアプリにアクセス
- 例：`http://example.com`（HTTPSではなくHTTP）
- ※ localhost/127.0.0.1 は例外的にHTTPでも動作

**期待される結果：**
- 「位置情報を取得」ボタンをタップ
- 即座にエラーメッセージが表示される：
  - 英語：「HTTPS connection required for location access」
  - 日本語：「位置情報取得にはHTTPS接続が必要です」

---

### テスト6: 住所の取得

**前提：** テスト1が成功していること

1. 位置情報を取得
2. 住所が表示されることを確認

**期待される結果：**
- オンラインの場合：
  ```
  東京都渋谷区
  Lat : 35.68945 , Lng : 139.70123
  ```

- オフラインの場合：
  ```
  -
  Lat : 35.68945 , Lng : 139.70123
  ```

---

### テスト7: 住所の再取得

**前提：** 位置情報は取得済み、住所が「-」の状態

1. インターネットに接続
2. [🔄 再取得] ボタンをタップ

**期待される結果：**
- ボタンが回転アニメーションを表示
- 数秒後、住所が表示される
- トーストメッセージ：「住所を更新しました」

---

### テスト8: 位置情報の削除

**前提：** 位置情報が取得済み

1. [🗑 削除] ボタンをタップ

**期待される結果：**
- 位置情報セクションが「📍 位置情報を取得」ボタンの状態に戻る
- 削除されたことが確認できる

---

## 🔍 デバッグ用のチェックリスト

### ブラウザコンソールで確認すべきこと

**位置情報取得開始時：**
```javascript
✅ "Requesting geolocation..." が表示される
✅ HTTPSの場合、HTTPS警告が出ない
```

**成功時：**
```javascript
✅ "Geolocation success: { latitude: ..., longitude: ..., accuracy: ... }"
✅ 緯度経度が妥当な値（日本の場合：緯度24-46、経度122-154）
✅ accuracy が表示される（精度、単位：メートル）
```

**失敗時：**
```javascript
✅ "Geolocation error details: { code: X, message: "...", errorName: "..." }"
✅ code が 1, 2, 3 のいずれか
✅ errorName が "PERMISSION_DENIED", "POSITION_UNAVAILABLE", "TIMEOUT" のいずれか
```

---

## 📊 テスト結果記録表

| # | テスト項目 | 期待結果 | 実際の結果 | 合格/不合格 | 備考 |
|---|----------|---------|-----------|----------|------|
| 1 | 位置情報取得成功 | 住所+緯度経度表示 | | ☐ 合格 ☐ 不合格 | |
| 2 | 位置情報拒否 | エラーメッセージ | | ☐ 合格 ☐ 不合格 | |
| 3 | タイムアウト | 15秒後にエラー | | ☐ 合格 ☐ 不合格 | |
| 4 | 位置情報利用不可 | エラーメッセージ | | ☐ 合格 ☐ 不合格 | |
| 5 | HTTPS接続チェック | 即座にエラー | | ☐ 合格 ☐ 不合格 | |
| 6 | 住所取得（オンライン） | 住所表示 | | ☐ 合格 ☐ 不合格 | |
| 6b | 住所取得（オフライン） | 「-」表示 | | ☐ 合格 ☐ 不合格 | |
| 7 | 住所の再取得 | 住所更新 | | ☐ 合格 ☐ 不合格 | |
| 8 | 位置情報の削除 | 元の状態に戻る | | ☐ 合格 ☐ 不合格 | |

---

## 🌍 ブラウザ別テスト

### Chrome（デスクトップ）
- [ ] Windows 10/11
- [ ] macOS
- [ ] Linux

### Chrome（モバイル）
- [ ] Android 11+
- [ ] Android 10以前

### Safari
- [ ] iOS 15+
- [ ] iOS 14以前
- [ ] macOS

### Edge
- [ ] Windows 10/11
- [ ] macOS

### Firefox
- [ ] Windows
- [ ] macOS
- [ ] Linux

---

## ⚠️ 既知の問題

### 1. iOS Safari でのタイムアウトが早い
- **現象：** iOS Safariでは10-15秒でタイムアウトすることがある
- **原因：** iOSのバッテリー最適化
- **回避策：** 省電力モードをオフにする

### 2. Android Chrome でのGPS精度が低い
- **現象：** 精度が100m以上になることがある
- **原因：** GPSではなくWi-Fi/携帯電波ベースの位置情報
- **回避策：** 位置情報モードを「高精度」に設定

### 3. Firefox でのHTTPS警告
- **現象：** 自己署名証明書でエラー
- **原因：** Firefoxのセキュリティ設定
- **回避策：** 正規のSSL証明書を使用

---

## 📝 フィードバック

テスト結果や問題があれば、以下の情報を含めて報告してください：

1. **ブラウザ情報**
   - ブラウザ名とバージョン
   - OS名とバージョン

2. **エラー内容**
   - コンソールログのスクリーンショット
   - エラーメッセージ

3. **再現手順**
   - 何をしたか
   - どうなったか
   - 期待していた動作

4. **環境情報**
   - オンライン/オフライン
   - 屋内/屋外
   - 位置情報サービスの設定
