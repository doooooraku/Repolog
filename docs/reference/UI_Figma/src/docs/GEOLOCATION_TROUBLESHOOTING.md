# 🗺️ 位置情報取得のトラブルシューティング

## 🔍 エラーの種類と対処法

### エラーコード 1: PERMISSION_DENIED
**メッセージ：** 「位置情報の取得が拒否されました」

**原因：**
- ユーザーがブラウザの許可ダイアログで「拒否」を選択した
- ブラウザの設定で位置情報が無効になっている
- OSの設定で位置情報が無効になっている

**対処法：**

#### Chrome（デスクトップ）
1. アドレスバーの左側の🔒アイコンをクリック
2. 「サイトの設定」をクリック
3. 「位置情報」を「許可」に変更
4. ページをリロード

#### Chrome（Android）
1. アドレスバーの左側のアイコンをタップ
2. 「権限」→「位置情報」
3. 「許可」を選択
4. ページをリロード

#### Safari（iPhone）
1. iPhoneの「設定」アプリを開く
2. 下にスクロールして「Safari」をタップ
3. 「位置情報」をタップ
4. 「このWebサイトを使用中」を選択
5. Safariに戻ってページをリロード

#### Safari（Mac）
1. Safariメニュー → 「環境設定」
2. 「Webサイト」タブをクリック
3. 左側の「位置情報サービス」を選択
4. 該当のWebサイトを「許可」に変更
5. ページをリロード

---

### エラーコード 2: POSITION_UNAVAILABLE
**メッセージ：** 「位置情報が利用できません」

**原因：**
- GPS信号を受信できない（屋内、地下など）
- Wi-Fi/携帯電波の位置情報サービスが無効
- デバイスの位置情報サービスがオフ
- ブラウザが位置情報を取得できない環境

**対処法：**

#### 一般的な対策
1. **屋外に出る**
   - GPS信号は建物の中では弱くなります
   - 窓の近くや屋外で試してください

2. **位置情報サービスを有効にする**

**iPhone:**
```
設定 → プライバシーとセキュリティ → 位置情報サービス → オン
```

**Android:**
```
設定 → 位置情報 → 位置情報を使用 → オン
```

3. **Wi-Fiをオンにする**
   - Wi-FiベースのGPSは屋内でも動作しやすい
   - インターネット接続は不要（Wi-FiをオンにするだけでOK）

4. **機内モードを解除**

5. **デバイスを再起動**

---

### エラーコード 3: TIMEOUT
**メッセージ：** 「位置情報の取得がタイムアウトしました」

**原因：**
- 15秒以内に位置情報を取得できなかった
- GPS信号が弱い
- デバイスの処理が遅い

**対処法：**

1. **もう一度試す**
   - 初回は時間がかかることがあります
   - 2回目以降は速くなります

2. **電波の良い場所に移動**
   - 窓の近く
   - 屋外
   - 高い場所

3. **他のアプリを閉じる**
   - デバイスのメモリ不足が原因の可能性

4. **しばらく待ってから再試行**
   - GPSが準備中の場合があります

---

## 🔒 HTTPS接続が必要

**メッセージ：** 「位置情報取得にはHTTPS接続が必要です」

**原因：**
- HTTP（暗号化されていない）接続でアクセスしている
- 最新のブラウザはセキュリティ上、HTTPS接続でのみ位置情報を許可

**例外：**
- `localhost` または `127.0.0.1` はHTTPでも動作します

**対処法：**

1. **URLをHTTPSに変更**
   ```
   ❌ http://example.com
   ✅ https://example.com
   ```

2. **開発者向け：SSL証明書を設定**
   - Let's Encrypt（無料）
   - Cloudflare（無料）
   - その他のSSL証明書プロバイダー

---

## 🌐 ブラウザが対応していない

**メッセージ：** 「このブラウザは位置情報取得に対応していません」

**原因：**
- 古いブラウザを使用している
- 位置情報APIに対応していないブラウザ

**対応ブラウザ：**
- ✅ Chrome 50+
- ✅ Safari 10+
- ✅ Firefox 50+
- ✅ Edge 14+
- ❌ Internet Explorer（非対応）

**対処法：**
1. ブラウザを最新版にアップデート
2. 別のブラウザを使用（Chrome、Safari、Edgeを推奨）

---

## 🐛 デバッグ方法

### コンソールログを確認

1. **Chromeの場合：**
   - F12キーを押す
   - 「Console」タブを開く
   - 「位置情報を取得」ボタンをタップ
   - ログを確認

2. **Safariの場合：**
   - 開発メニューを有効にする（設定 → 詳細 → 開発メニューを表示）
   - 開発 → JavaScriptコンソールを表示
   - 「位置情報を取得」ボタンをタップ
   - ログを確認

### ログの見方

#### 正常な場合：
```
Requesting geolocation...
Geolocation success: {
  latitude: 35.68945,
  longitude: 139.70123,
  accuracy: 15
}
```

#### エラーの場合：
```
Requesting geolocation...
Geolocation error details: {
  code: 1,
  message: "User denied Geolocation",
  errorName: "PERMISSION_DENIED"
}
```

**エラーコードの意味：**
- `code: 1` → PERMISSION_DENIED（拒否）
- `code: 2` → POSITION_UNAVAILABLE（利用不可）
- `code: 3` → TIMEOUT（タイムアウト）

---

## 📱 デバイス別の注意点

### iPhone / iPad

1. **Safari以外のブラウザの制限**
   - iOSでは、Chrome、Edgeも内部的にSafariのエンジンを使用
   - Safari自体の設定が影響します

2. **プライバシー設定**
   ```
   設定 → Safari → プライバシーとセキュリティ
   ```
   - 「サイト越えトラッキングを防ぐ」がオンでも位置情報は動作します
   - 「位置情報サービス」が有効である必要があります

3. **省電力モード**
   - 省電力モードでは位置情報の精度が下がる場合があります
   - GPSではなくWi-Fi/携帯電波ベースの位置情報になることがあります

### Android

1. **バッテリー最適化**
   - バッテリー最適化が有効だと位置情報が遅くなる場合があります
   
2. **位置情報モード**
   ```
   設定 → 位置情報 → 位置情報サービス
   ```
   - 「高精度」モードを推奨
   - 「バッテリー節約」モードでは精度が下がります

3. **Google Play開発者サービス**
   - 位置情報APIはGoogle Play開発者サービスに依存
   - アップデートを確認してください

### Windows / Mac

1. **Windows 10/11**
   ```
   設定 → プライバシーとセキュリティ → 位置情報
   ```
   - 「位置情報サービス」をオンにする
   - 「アプリが位置情報にアクセスすることを許可する」をオンにする

2. **macOS**
   ```
   システム環境設定 → セキュリティとプライバシー → プライバシー → 位置情報サービス
   ```
   - 位置情報サービスを有効にする
   - 左下の🔒をクリックして変更を許可

---

## ⚡ パフォーマンス最適化

### 取得時間を短縮する方法

1. **enableHighAccuracy を false にする**
   - 現在の設定：`enableHighAccuracy: true`（GPS優先）
   - 変更後：`enableHighAccuracy: false`（Wi-Fi/携帯電波優先）
   - 効果：1-3秒 → 0.5-1秒に短縮
   - トレードオフ：精度が10-100mに低下

2. **maximumAge を設定**
   - 現在の設定：`maximumAge: 0`（常に最新を取得）
   - 変更例：`maximumAge: 60000`（60秒以内のキャッシュを許可）
   - 効果：2回目以降は即座に取得
   - トレードオフ：古い位置情報の可能性

3. **timeout を短くする**
   - 現在の設定：`timeout: 15000`（15秒）
   - 変更例：`timeout: 5000`（5秒）
   - 効果：早くエラーを返す
   - トレードオフ：タイムアウトエラーが増える

---

## 🧪 テスト方法

### ブラウザで位置情報をテスト

#### Chrome DevTools
1. F12 → 「⋮」（その他のツール）→ 「Sensors」
2. 「Location」で任意の座標を設定
3. 「位置情報を取得」ボタンをテスト

#### Firefox
1. アドレスバーに `about:config` を入力
2. `geo.enabled` を検索
3. `true` に設定

---

## ❓ よくある質問

### Q: 毎回許可を求められる
**A:** Cookieやサイトデータが削除されている可能性があります。ブラウザの設定で「サイトデータを保存」を許可してください。

### Q: 位置情報は取得できるが、住所が「-」になる
**A:** 位置情報は取得できていますが、住所取得API（BigDataCloud）へのアクセスに失敗しています。
- インターネット接続を確認
- ファイアウォール設定を確認
- しばらく待ってから「🔄 再取得」をタップ

### Q: 精度が低い（100m以上ずれる）
**A:** 以下を確認してください：
- GPSをオンにする（屋外で最高精度）
- Wi-Fiをオンにする（屋内での精度向上）
- 「高精度モード」を有効にする
- 空が見える場所に移動する

### Q: 他のアプリでは動くのに、Repologでは動かない
**A:** ブラウザの位置情報設定を確認してください。アプリとブラウザは別々に権限が管理されています。

---

## 📞 それでも解決しない場合

1. **ブラウザのキャッシュをクリア**
2. **ブラウザを再起動**
3. **デバイスを再起動**
4. **別のブラウザで試す**
5. **別のデバイスで試す**

---

## 🔗 関連リンク

- [MDN: Geolocation API](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API)
- [Can I Use: Geolocation](https://caniuse.com/geolocation)
- [BigDataCloud API Documentation](https://www.bigdatacloud.com/docs/api/reverse-geocoding)
